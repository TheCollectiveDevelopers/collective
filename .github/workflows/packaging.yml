name: Build and Package

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  QT_VERSION: '6.10.0'
  CMAKE_VERSION: '3.28.x'
  APP_NAME: 'collective'

jobs:
  autotag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      tag: ${{ steps.autotag.outputs.new-tag}}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Auto Tag
        id: autotag
        uses: phish108/autotag-action@v1.1.55
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    needs: autotag
    if: always()
    runs-on: windows-latest
    permissions:
      contents: write
    strategy:
      matrix:
        version: [free, paid]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          modules: 'qtmultimedia qtpdf qt5compat qtshadertools'
          arch: 'win64_msvc2022_64'
          cache: true

      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: ${{ env.CMAKE_VERSION }}

      - name: Configure CMake
        run: |
          $USE_PAID = if ("${{ matrix.version }}" -eq "paid") { "ON" } else { "OFF" }
          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH=${{ env.Qt6_DIR }} -DUSE_PAID_VERSION=$USE_PAID

      - name: Build
        run: cmake --build build --config Release

      - name: Deploy Qt dependencies
        run: |
          cd build/Release
          windeployqt appcollective.exe --qmldir ../../qml --release --compiler-runtime

      - name: Create installer directory
        run: |
          mkdir installer
          xcopy build\Release installer\ /E /I /Y

      - name: Create Windows ZIP
        run: |
          cd installer
          7z a ../collective-windows-x86_64-${{ matrix.version }}.zip *

      - name: Install Qt Installer Framework
        run: |
          pip install aqtinstall
          aqt install-tool windows desktop tools_ifw --outputdir ${{ github.workspace }}\Qt

      - name: Copy installer icon to IFW config
        run: |
          copy assets\icon.ico packaging\windows\ifw\config\installer-icon.ico

      - name: Copy application to IFW package data
        run: |
          xcopy installer\* packaging\windows\ifw\packages\com.collective.app\data\ /E /I /Y

      - name: Create online installer
        run: |
          $IFW_PATH = Get-ChildItem -Path "${{ github.workspace }}\Qt\Tools\QtInstallerFramework" -Directory | Select-Object -First 1
          & "$IFW_PATH\bin\binarycreator.exe" -c packaging\windows\ifw\config\config.xml -p packaging\windows\ifw\packages collective-windows-x86_64-installer-online-${{ matrix.version }}.exe

      - name: Create repository for updates
        run: |
          $IFW_PATH = Get-ChildItem -Path "${{ github.workspace }}\Qt\Tools\QtInstallerFramework" -Directory | Select-Object -First 1
          & "$IFW_PATH\bin\repogen.exe" -p packaging\windows\ifw\packages repository

      - name: Create repository archive
        run: |
          cd repository
          7z a ../collective-windows-repository-${{ matrix.version }}.7z *

      - name: Create self-signed certificate
        run: |
          $cert = New-SelfSignedCertificate -Type CodeSigningCert -Subject "CN=Collective, O=Collective, C=US" -CertStoreLocation "Cert:\CurrentUser\My" -NotAfter (Get-Date).AddYears(5)
          $password = ConvertTo-SecureString -String "${{ secrets.CERT_PASSWORD }}" -Force -AsPlainText
          Export-PfxCertificate -Cert "Cert:\CurrentUser\My\$($cert.Thumbprint)" -FilePath "${{ github.workspace }}\certificate.pfx" -Password $password

      - name: Sign installer
        run: |
          # Find signtool in Windows SDK
          $signtool = Get-ChildItem -Path "C:\Program Files (x86)\Windows Kits\10\bin\*\x64\signtool.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($signtool) {
            & $signtool.FullName sign /f "${{ github.workspace }}\certificate.pfx" /p "${{ secrets.CERT_PASSWORD }}" /fd SHA256 /tr http://timestamp.digicert.com /td SHA256 collective-windows-x86_64-installer-online-${{ matrix.version }}.exe
          } else {
            Write-Host "signtool not found, trying from PATH"
            signtool sign /f "${{ github.workspace }}\certificate.pfx" /p "${{ secrets.CERT_PASSWORD }}" /fd SHA256 /tr http://timestamp.digicert.com /td SHA256 collective-windows-x86_64-installer-online-${{ matrix.version }}.exe
          }

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            collective-windows-x86_64-${{ matrix.version }}.zip
            collective-windows-x86_64-installer-online-${{ matrix.version }}.exe
            collective-windows-repository-${{ matrix.version }}.7z
          tag_name: ${{ needs.autotag.outputs.new-tag || 'latest' }}
          name: ${{ needs.autotag.outputs.new-tag || 'Latest Build' }}
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    needs: autotag
    if: always()
    runs-on: macos-latest
    permissions:
      contents: write
    strategy:
      matrix:
        version: [free, paid]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          modules: 'qtmultimedia qtpdf qt5compat qtshadertools'
          cache: true

      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: ${{ env.CMAKE_VERSION }}

      - name: Configure CMake
        run: |
          USE_PAID=${{ matrix.version == 'paid' && 'ON' || 'OFF' }}
          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH=${{ env.Qt6_DIR }} -DUSE_PAID_VERSION=$USE_PAID

      - name: Build
        run: cmake --build build --config Release

      - name: Deploy Qt dependencies
        run: |
          macdeployqt build/appcollective.app -qmldir=qml -dmg
          mv build/appcollective.dmg build/collective-macos-${{ matrix.version }}.dmg

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: build/collective-macos-${{ matrix.version }}.dmg
          tag_name: ${{ needs.autotag.outputs.new-tag || 'latest' }}
          name: ${{ needs.autotag.outputs.new-tag || 'Latest Build' }}
          draft: false

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux-appimage:
    needs: autotag
    if: always()
    runs-on: ubuntu-latest
    permissions:
          contents: write
    strategy:
      matrix:
        version: [free, paid]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgl1-mesa-dev \
            libxkbcommon-x11-0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-render-util0 \
            libxcb-xinerama0 \
            libxcb-cursor0 \
            libxcb-shape0 \
            libdbus-1-dev \
            libpulse-dev \
            libasound2-dev \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            file \
            wget

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          modules: 'qtmultimedia qt5compat qtpdf qtshadertools'
          cache: true

      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: ${{ env.CMAKE_VERSION }}

      - name: Configure CMake
        run: |
          USE_PAID=${{ matrix.version == 'paid' && 'ON' || 'OFF' }}
          cmake -B build -S . \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DCMAKE_PREFIX_PATH=${{ env.Qt6_DIR }} \
            -DUSE_PAID_VERSION=$USE_PAID

      - name: Build
        run: cmake --build build --config Release

      - name: Install to AppDir
        run: |
          DESTDIR=AppDir cmake --install build

      - name: Download linuxdeploy and Qt plugin
        run: |
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x linuxdeploy*.AppImage

      - name: Create AppImage
        env:
          QMAKE: ${{ env.Qt6_DIR }}/bin/qmake
          UPDATE_INFORMATION: "zsync|https://collectiveboard.pages.dev/linux/Collective.AppImage.zsync"
        run: |
          # Create wrapper script
          cat > AppDir/usr/bin/appcollective-wrapper.sh <<EOF
          #!/bin/bash
          export QT_QPA_PLATFORM=xcb
          DIR="\$(dirname "\$(readlink -f "\$0")")"
          exec "\$DIR/appcollective" "\$@"
          EOF
          chmod +x AppDir/usr/bin/appcollective-wrapper.sh

          # Create desktop file
          cat > collective.desktop <<EOF
          [Desktop Entry]
          Type=Application
          Name=Collective
          Exec=appcollective-wrapper.sh
          Icon=collective
          Categories=Utility;
          Terminal=false
          EOF

          # Copy icon
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          cp assets/icon.png AppDir/usr/share/icons/hicolor/256x256/apps/collective.png

          # Set environment variables for linuxdeploy
          export QML_SOURCES_PATHS=qml
          export EXTRA_QT_PLUGINS="multimedia"

          # Create AppImage
          ./linuxdeploy-x86_64.AppImage \
            --appdir AppDir \
            --plugin qt \
            --desktop-file=collective.desktop \
            --icon-file=assets/icon.png \
            --output appimage

      - name: Rename AppImage
        run: |
          mv Collective-*.AppImage Collective-${{ matrix.version }}.AppImage || true
          ls -la *.AppImage

      - name: Generate zsync file
        run: |
          sudo apt-get install -y zsync
          zsyncmake -u https://collectiveboard.pages.dev/linux/Collective-${{ matrix.version }}.AppImage Collective-${{ matrix.version }}.AppImage

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            Collective-${{ matrix.version }}.AppImage
            Collective-${{ matrix.version }}.AppImage.zsync
          tag_name: ${{ needs.autotag.outputs.new-tag || 'latest' }}
          name: ${{ needs.autotag.outputs.new-tag || 'Latest Build' }}
          draft: false

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
